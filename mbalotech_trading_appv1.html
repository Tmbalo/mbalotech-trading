<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MbaloTech Trading App</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional trading assistant and journal">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MbaloTech Trading">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjMjU2M2ViIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjMjU2M2ViIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=">
    
    <!-- Manifest -->
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overscroll-behavior: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .mobile-scroll {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Install button animation */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .install-prompt {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Install prompt for PWA -->
    <div id="install-prompt" class="hidden fixed bottom-4 left-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 install-prompt">
        <div class="flex items-center justify-between">
            <div>
                <div class="font-semibold">Install MbaloTech Trading</div>
                <div class="text-sm opacity-90">Get the full app experience</div>
            </div>
            <div class="flex space-x-2">
                <button id="install-dismiss" class="px-3 py-1 bg-white bg-opacity-20 rounded text-sm">
                    Later
                </button>
                <button id="install-accept" class="px-3 py-1 bg-white text-blue-600 rounded text-sm font-medium">
                    Install
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Create manifest dynamically
        const manifest = {
            name: "MbaloTech Trading App",
            short_name: "MbaloTech",
            description: "Professional trading assistant and journal",
            start_url: "./",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2563eb",
            orientation: "portrait-primary",
            scope: "./",
            icons: [
                {
                    src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjMjU2M2ViIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=",
                    sizes: "192x192",
                    type: "image/svg+xml"
                },
                {
                    src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHJ4PSI0IiBmaWxsPSIjMjU2M2ViIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=",
                    sizes: "512x512",
                    type: "image/svg+xml"
                }
            ]
        };

        // Set manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').href = manifestURL;

        // PWA Install functionality
        let deferredPrompt;
        const installPrompt = document.getElementById('install-prompt');
        const installAccept = document.getElementById('install-accept');
        const installDismiss = document.getElementById('install-dismiss');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 10 seconds if not installed
            setTimeout(() => {
                if (!window.matchMedia('(display-mode: standalone)').matches) {
                    installPrompt.classList.remove('hidden');
                }
            }, 10000);
        });

        installAccept.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
            }
            installPrompt.classList.add('hidden');
        });

        installDismiss.addEventListener('click', () => {
            installPrompt.classList.add('hidden');
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'mbalotech-trading-v1';
                    const urlsToCache = [
                        './',
                        './manifest.json'
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);
                
                navigator.serviceWorker.register(swUrl)
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Enhanced local storage for mobile
        const Storage = {
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.warn('Storage quota exceeded');
                }
            },
            get: (key) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    return null;
                }
            },
            remove: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('Storage error');
                }
            }
        };

        window.MbaloStorage = Storage;
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Import icons (same as before)
        const CheckCircle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="9,11 12,14 22,4"></polyline>
            </svg>
        );

        const XCircle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        );

        const TrendingUp = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"></polyline>
                <polyline points="17,6 23,6 23,12"></polyline>
            </svg>
        );

        const Lock = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <circle cx="12" cy="16" r="1"></circle>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const Target = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </svg>
        );

        const BarChart3 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 3v18h18"></path>
                <path d="M18 17V9"></path>
                <path d="M13 17V5"></path>
                <path d="M8 17v-3"></path>
            </svg>
        );

        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Clock = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
        );

        const DollarSign = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        );

        const AlertTriangle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        );

        const Settings = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        );

        const Trash2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Edit3 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
        );

        const Plus = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Activity = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"></polyline>
            </svg>
        );

        // Enhanced MbaloTech Trading App with PWA features
        const MbaloTechTradingApp = () => {
            // Core state management with persistent storage
            const [currentView, setCurrentView] = useState('dashboard');
            const [isLocked, setIsLocked] = useState(false);
            const [lockReason, setLockReason] = useState('');
            const [lockUntil, setLockUntil] = useState(null);
            
            // Trading data state
            const [trades, setTrades] = useState([]);
            const [activeTrades, setActiveTrades] = useState([]);
            const [tradingRules, setTradingRules] = useState({
                maxDailyLoss: 1000,
                maxPositionSize: 0.1,
                maxRiskPerTrade: 2,
                maxConsecutiveLosses: 2,
                maxDailyTrades: 5,
                mandatoryBreakHours: 24
            });

            // Daily stats with enhanced tracking
            const [dailyStats, setDailyStats] = useState({
                date: new Date().toISOString().split('T')[0],
                tradesCount: 0,
                dailyPnL: 0,
                maxDrawdown: 0,
                consecutiveLosses: 0,
                emotionalState: 5,
                discipline: 5,
                focus: 5,
                marketConditions: 'normal'
            });

            // Enhanced pre-trade checklist
            const [preTradeChecklist, setPreTradeChecklist] = useState({
                marketAnalysis: false,
                riskAssessment: false,
                emotionalCheck: false,
                positionSize: false,
                exitStrategy: false,
                timeAvailable: false,
                newsCheck: false,
                technicalSetup: false
            });

            // Enhanced trade entry state
            const [currentTrade, setCurrentTrade] = useState({
                id: null,
                symbol: '',
                side: 'long',
                entryPrice: '',
                stopLoss: '',
                takeProfit: '',
                positionSize: '',
                timeframe: '1h',
                setup: 'breakout',
                confidence: 3,
                emotionalState: 'calm',
                marketCondition: 'trending',
                notes: '',
                riskRewardRatio: 0,
                riskAmount: 0,
                potentialReward: 0,
                entryReason: '',
                exitPlan: ''
            });

            // Load data from storage on startup
            useEffect(() => {
                const savedTrades = window.MbaloStorage.get('trades');
                const savedRules = window.MbaloStorage.get('tradingRules');
                const savedStats = window.MbaloStorage.get('dailyStats');
                const savedLock = window.MbaloStorage.get('lockStatus');
                
                if (savedTrades) setTrades(savedTrades);
                if (savedRules) setTradingRules(savedRules);
                if (savedStats) setDailyStats(savedStats);
                if (savedLock && savedLock.isLocked) {
                    setIsLocked(savedLock.isLocked);
                    setLockReason(savedLock.reason);
                    setLockUntil(savedLock.until);
                }
            }, []);

            // Save data to storage when state changes
            useEffect(() => {
                window.MbaloStorage.set('trades', trades);
            }, [trades]);

            useEffect(() => {
                window.MbaloStorage.set('tradingRules', tradingRules);
            }, [tradingRules]);

            useEffect(() => {
                window.MbaloStorage.set('dailyStats', dailyStats);
            }, [dailyStats]);

            useEffect(() => {
                window.MbaloStorage.set('lockStatus', {
                    isLocked,
                    reason: lockReason,
                    until: lockUntil
                });
            }, [isLocked, lockReason, lockUntil]);

            // Memoized input handlers
            const handleTradeInputChange = useCallback((field, value) => {
                setCurrentTrade(prev => {
                    const updated = { ...prev, [field]: value };
                    
                    // Auto-calculate risk/reward when prices change
                    if (['entryPrice', 'stopLoss', 'takeProfit', 'positionSize'].includes(field)) {
                        const entry = parseFloat(updated.entryPrice) || 0;
                        const stop = parseFloat(updated.stopLoss) || 0;
                        const target = parseFloat(updated.takeProfit) || 0;
                        const size = parseFloat(updated.positionSize) || 0;
                        
                        if (entry && stop && target && size) {
                            const riskPips = updated.side === 'long' ? 
                                Math.abs(entry - stop) : Math.abs(stop - entry);
                            const rewardPips = updated.side === 'long' ? 
                                Math.abs(target - entry) : Math.abs(entry - target);
                            
                            updated.riskRewardRatio = rewardPips / riskPips;
                            updated.riskAmount = riskPips * size * 100000; // Assuming standard lot calculation
                            updated.potentialReward = rewardPips * size * 100000;
                        }
                    }
                    
                    return updated;
                });
            }, []);

            const handleChecklistChange = useCallback((field, checked) => {
                setPreTradeChecklist(prev => ({
                    ...prev,
                    [field]: checked
                }));
            }, []);

            // Enhanced statistics calculation
            const calculateStats = useCallback(() => {
                const totalTrades = trades.length;
                const winningTrades = trades.filter(t => t.outcome === 'win').length;
                const losingTrades = trades.filter(t => t.outcome === 'loss').length;
                const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 0;
                const totalPnL = trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
                
                // Calculate additional metrics
                const avgWin = winningTrades > 0 ? 
                    trades.filter(t => t.outcome === 'win').reduce((sum, t) => sum + t.pnl, 0) / winningTrades : 0;
                const avgLoss = losingTrades > 0 ? 
                    trades.filter(t => t.outcome === 'loss').reduce((sum, t) => sum + Math.abs(t.pnl), 0) / losingTrades : 0;
                const profitFactor = avgLoss > 0 ? (avgWin * winningTrades) / (avgLoss * losingTrades) : 0;
                
                // Get recent consecutive losses
                const recentTrades = trades.slice(-5);
                let consecutiveLosses = 0;
                for (let i = recentTrades.length - 1; i >= 0; i--) {
                    if (recentTrades[i].outcome === 'loss') {
                        consecutiveLosses++;
                    } else {
                        break;
                    }
                }
                
                return { 
                    totalTrades, 
                    winningTrades, 
                    losingTrades, 
                    winRate, 
                    totalPnL,
                    avgWin: avgWin.toFixed(0),
                    avgLoss: avgLoss.toFixed(0),
                    profitFactor: profitFactor.toFixed(2),
                    consecutiveLosses
                };
            }, [trades]);

            const stats = calculateStats();

            // Enhanced emergency stop function
            const emergencyStop = useCallback((reason) => {
                const lockUntilTime = new Date(Date.now() + (tradingRules.mandatoryBreakHours * 60 * 60 * 1000));
                setIsLocked(true);
                setLockReason(reason);
                setLockUntil(lockUntilTime);
                
                // Close any active trades (in real app, this would interface with broker)
                setActiveTrades([]);
                
                // Reset forms
                setPreTradeChecklist({
                    marketAnalysis: false,
                    riskAssessment: false,
                    emotionalCheck: false,
                    positionSize: false,
                    exitStrategy: false,
                    timeAvailable: false,
                    newsCheck: false,
                    technicalSetup: false
                });
                setCurrentView('dashboard');
            }, [tradingRules.mandatoryBreakHours]);

            // Check trading rules violations
            useEffect(() => {
                if (stats.consecutiveLosses >= tradingRules.maxConsecutiveLosses && !isLocked) {
                    emergencyStop(`${tradingRules.maxConsecutiveLosses} consecutive losses - mandatory break`);
                }
                
                if (dailyStats.dailyPnL <= -tradingRules.maxDailyLoss && !isLocked) {
                    emergencyStop(`Daily loss limit reached (${tradingRules.maxDailyLoss})`);
                }
                
                if (dailyStats.tradesCount >= tradingRules.maxDailyTrades && !isLocked) {
                    emergencyStop(`Daily trade limit reached (${tradingRules.maxDailyTrades})`);
                }
            }, [stats.consecutiveLosses, dailyStats.dailyPnL, dailyStats.tradesCount, tradingRules, isLocked, emergencyStop]);

            // Check if lock should be lifted
            useEffect(() => {
                if (isLocked && lockUntil && new Date() > new Date(lockUntil)) {
                    setIsLocked(false);
                    setLockReason('');
                    setLockUntil(null);
                }
            }, [isLocked, lockUntil]);

            // Mobile-optimized components would go here...
            // For brevity, I'll include just the dashboard view as an example

            const DashboardView = () => {
                const progressToGoal = Math.max(0, (stats.totalPnL / 480000 * 100)).toFixed(1);
                
                return (
                    <div className="space-y-4 mobile-scroll">
                        {/* Mobile-optimized lock status */}
                        {isLocked && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-lg text-sm">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center">
                                        <Lock className="w-4 h-4 mr-2" />
                                        <span className="font-medium">Trading Suspended</span>
                                    </div>
                                    {lockUntil && (
                                        <div className="text-xs">
                                            Until: {new Date(lockUntil).toLocaleTimeString()}
                                        </div>
                                    )}
                                </div>
                                <div className="mt-1 text-xs">{lockReason}</div>
                            </div>
                        )}

                        {/* Mobile-optimized goal progress */}
                        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-lg">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-lg font-semibold">Annual Goal</h3>
                                <Target className="w-5 h-5" />
                            </div>
                            <div className="text-2xl font-bold mb-1">${stats.totalPnL.toLocaleString()}</div>
                            <div className="text-sm opacity-90">Target: $480,000</div>
                            <div className="w-full bg-white bg-opacity-20 rounded-full h-2 mt-2">
                                <div 
                                    className="bg-white h-2 rounded-full transition-all duration-500"
                                    style={{ width: `${Math.min(progressToGoal, 100)}%` }}
                                />
                            </div>
                            <div className="text-sm mt-1">{progressToGoal}% complete</div>
                        </div>

                        {/* Mobile-optimized stats grid */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-white p-3 rounded-lg shadow">
                                <div className="text-lg font-bold">{stats.totalTrades}</div>
                                <div className="text-xs text-gray-600">Total Trades</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg shadow">
                                <div className="text-lg font-bold text-green-600">{stats.winRate}%</div>
                                <div className="text-xs text-gray-600">Win Rate</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg shadow">
                                <div className="text-lg font-bold text-blue-600">{stats.profitFactor}</div>
                                <div className="text-xs text-gray-600">Profit Factor</div>
                            </div>
                            <div className="bg-white p-3 rounded-lg shadow">
                                <div className={`text-lg font-bold ${stats.consecutiveLosses >= 2 ? 'text-red-600' : 'text-green-600'}`}>
                                    {stats.consecutiveLosses}
                                </div>
                                <div className="text-xs text-gray-600">Consecutive Losses</div>
                            </div>
                        </div>

                        {/* Recent trades - mobile optimized */}
                        <div className="bg-white rounded-lg shadow">
                            <div className="p-4 border-b">
                                <h3 className="text-lg font-semibold">Recent Trades</h3>
                            </div>
                            <div className="p-4">
                                {trades.length === 0 ? (
                                    <div className="text-center text-gray-500 py-6">
                                        <BarChart3 className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                        <div className="text-sm font-medium mb-1">No trades yet</div>
                                        <div className="text-xs">Complete checklist to start!</div>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {trades.slice(-5).reverse().map(trade => (
                                            <div key={trade.id} className="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                                                <div className="flex items-center space-x-2">
                                                    <div className="font-medium">{trade.symbol}</div>
                                                    <div className={`px-1 py-0.5 rounded text-xs ${
                                                        trade.side === 'long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                    }`}>
                                                        {trade.side.toUpperCase()}
                                                    </div>
                                                    <div className={`text-xs font-medium ${
                                                        trade.outcome === 'win' ? 'text-green-600' : 'text-red-600'
                                                    }`}>
                                                        ${trade.pnl > 0 ? '+' : ''}${trade.pnl.toFixed(0)}
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-xs font-medium">{trade.entryPrice}</div>
                                                    <div className="text-xs text-gray-500">
                                                        {new Date(trade.timestamp).toLocaleTimeString()}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // For this example, I'll keep the dashboard view. In the full version, all components would be mobile-optimized
            return (
                <div className="min-h-screen bg-gray-100 pb-safe">
                    {/* Mobile-optimized header */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-2">
                                    <Target className="w-6 h-6 text-blue-600" />
                                    <div>
                                        <h1 className="text-lg font-bold text-gray-900">MbaloTech</h1>
                                        <div className="text-xs text-gray-500">Trading Assistant</div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs text-gray-600">
                                        {new Date().toLocaleDateString()}
                                    </div>
                                    <div className="text-xs text-gray-500 flex items-center justify-end">
                                        <Clock className="w-3 h-3 mr-1" />
                                        {new Date().toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Mobile-optimized navigation */}
                    <div className="px-4 py-3">
                        <div className="flex space-x-2 overflow-x-auto">
                            <button
                                onClick={() => setCurrentView('dashboard')}
                                className={`px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${
                                    currentView === 'dashboard' 
                                        ? 'bg-blue-600 text-white' 
                                        : 'bg-white text-gray-700'
                                }`}
                            >
                                Dashboard
                            </button>
                            <button
                                onClick={() => setCurrentView('checklist')}
                                disabled={isLocked}
                                className={`px-3 py-2 rounded-lg font-medium transition-colors whitespace-nowrap text-sm ${
                                    currentView === 'checklist' 
                                        ? 'bg-blue-600 text-white' 
                                        : isLocked 
                                            ? 'bg-gray-300 text-gray-500'
                                            : 'bg-white text-gray-700'
                                }`}
                            >
                                New Trade
                            </button>
                            <button
                                onClick={() => emergencyStop('Manual emergency stop')}
                                disabled={isLocked}
                                className="px-3 py-2 bg-red-600 text-white rounded-lg font-medium text-sm whitespace-nowrap disabled:bg-gray-400"
                            >
                                Stop
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="px-4 pb-4">
                        <DashboardView />
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MbaloTechTradingApp />, document.getElementById('root'));
    </script>
</body>
</html>