<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MbaloTech Trading App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        input, select, textarea {
            font-size: 16px !important;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }
        
        .hidden { display: none !important; }
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>
    <!-- App Container - Show immediately -->
    <div id="app">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-6xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">M</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">MbaloTech Trading</h1>
                            <div class="text-sm text-gray-500">Professional Trading Assistant</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600" id="current-date"></div>
                        <div class="text-xs text-gray-500" id="current-time"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="showView('dashboard')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white" data-view="dashboard">
                    Dashboard
                </button>
                <button onclick="showView('checklist')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50" data-view="checklist">
                    ‚ûï New Trade
                </button>
                <button onclick="showView('settings')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors bg-white text-gray-700 hover:bg-gray-50" data-view="settings">
                    ‚öôÔ∏è Settings
                </button>
                <button onclick="emergencyStop()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                    üö® Emergency Stop
                </button>
            </div>

            <!-- Main Content Container -->
            <div class="max-w-5xl mx-auto">
                
                <!-- Dashboard View -->
                <div id="dashboard" class="view active">
                    <div class="space-y-6">
                        <!-- Goal Progress -->
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-semibold">Annual Goal Progress</h3>
                                <span class="text-2xl">üéØ</span>
                            </div>
                            <div class="text-3xl font-bold mb-1" id="total-pnl">$200</div>
                            <div class="text-sm opacity-90">Target: $480,000</div>
                            <div class="w-full bg-white bg-opacity-20 rounded-full h-3 mt-3">
                                <div class="bg-white h-3 rounded-full transition-all duration-500" id="progress-bar" style="width: 0.04%"></div>
                            </div>
                            <div class="text-sm mt-2" id="progress-text">0.04% complete</div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="text-2xl font-bold" id="total-trades">2</div>
                                <div class="text-sm text-gray-600">Total Trades</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="text-2xl font-bold text-green-600" id="win-rate">50%</div>
                                <div class="text-sm text-gray-600">Win Rate</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="text-2xl font-bold text-green-600" id="winning-trades">1</div>
                                <div class="text-sm text-gray-600">Winning Trades</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="text-2xl font-bold text-red-600" id="losing-trades">1</div>
                                <div class="text-sm text-gray-600">Losing Trades</div>
                            </div>
                        </div>

                        <!-- Recent Trades -->
                        <div class="bg-white rounded-lg shadow">
                            <div class="p-4 border-b">
                                <h3 class="text-lg font-semibold">Recent Trades</h3>
                            </div>
                            <div class="p-4" id="recent-trades">
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                                        <div class="flex items-center space-x-3">
                                            <div class="font-medium">EURUSD</div>
                                            <div class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">LONG</div>
                                            <div class="text-sm text-gray-600">breakout</div>
                                            <div class="text-sm font-medium text-green-600">+$450</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-medium">1.08500</div>
                                            <div class="text-xs text-gray-500">2 hours ago</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors">
                                        <div class="flex items-center space-x-3">
                                            <div class="font-medium">GBPJPY</div>
                                            <div class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">SHORT</div>
                                            <div class="text-sm text-gray-600">reversal</div>
                                            <div class="text-sm font-medium text-red-600">-$250</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-medium">188.50</div>
                                            <div class="text-xs text-gray-500">4 hours ago</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pre-Trade Checklist View -->
                <div id="checklist" class="view">
                    <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Pre-Trade Checklist</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="font-semibold text-red-600 mb-3 flex items-center">
                                    ‚ö†Ô∏è Critical Items (Required)
                                </h3>
                                <div class="space-y-3" id="critical-checklist">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-red-600 critical-item" data-key="marketAnalysis">
                                        <span class="text-gray-700">Market structure and trend analysis completed</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-red-600 critical-item" data-key="technicalSetup">
                                        <span class="text-gray-700">Technical setup confirmed with multiple timeframes</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-red-600 critical-item" data-key="riskAssessment">
                                        <span class="text-gray-700">Risk/reward ratio calculated (minimum 1:2)</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-red-600 critical-item" data-key="positionSize">
                                        <span class="text-gray-700">Position size calculated (max 2% account risk)</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-red-600 critical-item" data-key="exitStrategy">
                                        <span class="text-gray-700">Stop loss and take profit levels defined</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-semibold text-blue-600 mb-3">Optional Items</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-blue-600" data-key="emotionalCheck">
                                        <span class="text-gray-700">Emotional state is calm and focused</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-blue-600" data-key="newsCheck">
                                        <span class="text-gray-700">Economic calendar checked for high-impact news</span>
                                    </label>
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" class="w-5 h-5 text-blue-600" data-key="timeAvailable">
                                        <span class="text-gray-700">Sufficient time available to monitor trade</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 flex gap-4">
                            <button onclick="showView('dashboard')" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors">
                                Cancel
                            </button>
                            <button onclick="checkAndProceed()" id="proceed-btn" class="flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
                                Complete Critical Items
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Trade Entry View -->
                <div id="trade-entry" class="view">
                    <div class="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Trade Entry</h2>
                            <div class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800" id="trade-status">
                                Incomplete
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Symbol *</label>
                                <input type="text" id="symbol" placeholder="GOLD" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Direction *</label>
                                <select id="side" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="long">Long (Buy)</option>
                                    <option value="short">Short (Sell)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Entry Price *</label>
                                <input type="text" id="entryPrice" placeholder="2650.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Stop Loss *</label>
                                <input type="text" id="stopLoss" placeholder="2630.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Take Profit *</label>
                                <input type="text" id="takeProfit" placeholder="2690.00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Position Size (lots) *</label>
                                <input type="text" id="positionSize" placeholder="0.002" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">Example: 0.002 for micro lot</div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Exit Price (optional)</label>
                                <input type="text" id="exitPrice" placeholder="2690.72" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- Trading Calculations Display -->
                        <div id="calculations" class="bg-gray-50 p-4 rounded-lg mb-6 hidden">
                            <h3 class="font-semibold mb-3">Trading Calculations</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                                <div>
                                    <div class="text-lg font-bold text-red-600" id="calc-risk">$0</div>
                                    <div class="text-sm text-gray-600">Risk Amount</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-green-600" id="calc-reward">$0</div>
                                    <div class="text-sm text-gray-600">Potential Reward</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-blue-600" id="calc-ratio">1:0.00</div>
                                    <div class="text-sm text-gray-600">Risk:Reward</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-blue-600" id="calc-volume">0</div>
                                    <div class="text-sm text-gray-600">Lot Size</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center text-sm">
                                <div>
                                    <div class="font-medium text-red-600" id="calc-risk-pips">0 points</div>
                                    <div class="text-xs text-gray-500">Risk Points</div>
                                </div>
                                <div>
                                    <div class="font-medium text-green-600" id="calc-reward-pips">0 points</div>
                                    <div class="text-xs text-gray-500">Reward Points</div>
                                </div>
                                <div id="actual-pips-container" class="hidden">
                                    <div class="font-medium" id="calc-actual-pips">0 points</div>
                                    <div class="text-xs text-gray-500">Actual Points</div>
                                </div>
                                <div id="actual-pnl-container" class="hidden">
                                    <div class="font-medium" id="calc-actual-pnl">$0</div>
                                    <div class="text-xs text-gray-500">Actual P&L</div>
                                </div>
                            </div>
                        </div>

                        <!-- Confidence Slider -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Confidence Level: <span id="confidence-value">3</span>/5
                            </label>
                            <input type="range" id="confidence" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Very Low</span>
                                <span>Low</span>
                                <span>Medium</span>
                                <span>High</span>
                                <span>Very High</span>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trade Notes</label>
                            <textarea id="notes" rows="3" placeholder="Why are you taking this trade? What's your analysis?" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="showView('checklist')" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors">
                                Back to Checklist
                            </button>
                            <button onclick="submitTrade()" id="submit-trade-btn" class="flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
                                Complete Required Fields
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settings" class="view">
                    <div class="max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">Settings & Data Management</h2>
                        
                        <div class="space-y-6">
                            <!-- Export Section -->
                            <div class="border-b pb-6">
                                <h3 class="text-lg font-semibold mb-4 text-green-600">üìä Export Data</h3>
                                <div class="space-y-3">
                                    <button onclick="exportToGoogleSheets()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center justify-center">
                                        üìã Export to Google Sheets
                                    </button>
                                    <button onclick="exportToCSV()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center justify-center">
                                        üíæ Download as CSV
                                    </button>
                                    <button onclick="exportToJSON()" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-purple-700 transition-colors flex items-center justify-center">
                                        üìÑ Download as JSON
                                    </button>
                                </div>
                            </div>

                            <!-- Statistics -->
                            <div class="border-b pb-6">
                                <h3 class="text-lg font-semibold mb-4 text-blue-600">üìà Trading Statistics</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm" id="detailed-stats">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Danger Zone -->
                            <div>
                                <h3 class="text-lg font-semibold mb-4 text-red-600">‚ö†Ô∏è Danger Zone</h3>
                                <div class="space-y-3">
                                    <button onclick="clearAllTrades()" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors flex items-center justify-center">
                                        üóëÔ∏è Clear All Trades
                                    </button>
                                    <button onclick="emergencyStop()" class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors flex items-center justify-center">
                                        üö® Emergency Stop (24h Trading Lock)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8">
                            <button onclick="showView('dashboard')" class="w-full bg-gray-500 text-white py-3 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors">
                                Back to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Stop Modal -->
    <div id="emergency-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md mx-4">
            <h3 class="text-xl font-bold text-red-600 mb-4">üö® Emergency Stop Activated</h3>
            <p class="text-gray-700 mb-6">Trading has been suspended for 24 hours. This is a protective measure to prevent emotional trading and preserve capital.</p>
            <div class="text-sm text-gray-600 mb-4">
                <div>Suspension ends: <span id="lock-end-time" class="font-medium"></span></div>
            </div>
            <button onclick="closeEmergencyModal()" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition-colors">
                Understood
            </button>
        </div>
    </div>

    <script>
        // Initialize immediately - no loading screen
        let trades = JSON.parse(localStorage.getItem('mbalotech_trades') || '[]');
        let isEmergencyLocked = JSON.parse(localStorage.getItem('mbalotech_emergency_lock') || 'false');
        let lockEndTime = localStorage.getItem('mbalotech_lock_end_time') || null;

        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
        }

        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewName).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-white', 'text-gray-700');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-white', 'text-gray-700');
                }
            });
        }

        function calculateTradingMetrics() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const side = document.getElementById('side').value;
            const entryPrice = parseFloat(document.getElementById('entryPrice').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stopLoss').value) || 0;
            const takeProfit = parseFloat(document.getElementById('takeProfit').value) || 0;
            const positionSize = parseFloat(document.getElementById('positionSize').value) || 0;
            const exitPrice = parseFloat(document.getElementById('exitPrice').value) || 0;

            if (!entryPrice || !stopLoss || !takeProfit || !positionSize) {
                document.getElementById('calculations').classList.add('hidden');
                return null;
            }

            // Gold calculation: 1 lot = 100oz, $0.01 move = $1 per lot
            let riskPoints, rewardPoints, riskAmount, rewardAmount;
            
            if (symbol === 'GOLD' || symbol === 'XAUUSD') {
                riskPoints = side === 'long' ? Math.abs(entryPrice - stopLoss) : Math.abs(stopLoss - entryPrice);
                rewardPoints = side === 'long' ? Math.abs(takeProfit - entryPrice) : Math.abs(entryPrice - takeProfit);
                
                // For Gold: P&L = Price Difference √ó Lot Size √ó 100
                riskAmount = riskPoints * positionSize * 100;
                rewardAmount = rewardPoints * positionSize * 100;
            } else {
                // Default forex calculation
                const pipValue = symbol.includes('JPY') ? 0.01 : 0.0001;
                riskPoints = side === 'long' ? 
                    Math.abs(entryPrice - stopLoss) / pipValue : 
                    Math.abs(stopLoss - entryPrice) / pipValue;
                rewardPoints = side === 'long' ? 
                    Math.abs(takeProfit - entryPrice) / pipValue : 
                    Math.abs(entryPrice - takeProfit) / pipValue;
                
                const volume = positionSize * 10;
                riskAmount = (volume * 10) * riskPoints / 10;
                rewardAmount = (volume * 10) * rewardPoints / 10;
            }

            const ratio = riskPoints > 0 ? rewardPoints / riskPoints : 0;

            // Calculate actual P&L if exit price provided
            let actualPoints = 0;
            let actualPnL = 0;

            if (exitPrice) {
                if (symbol === 'GOLD' || symbol === 'XAUUSD') {
                    actualPoints = side === 'long' ? (exitPrice - entryPrice) : (entryPrice - exitPrice);
                    actualPnL = actualPoints * positionSize * 100;
                } else {
                    const pipValue = symbol.includes('JPY') ? 0.01 : 0.0001;
                    actualPoints = side === 'long' ? 
                        (exitPrice - entryPrice) / pipValue : 
                        (entryPrice - exitPrice) / pipValue;
                    const volume = positionSize * 10;
                    actualPnL = ((volume * 10) * actualPoints) / 10;
                }
            }

            // Update display
            const pointLabel = (symbol === 'GOLD' || symbol === 'XAUUSD') ? 'points' : 'pips';
            
            document.getElementById('calc-risk').textContent = `$${riskAmount.toFixed(2)}`;
            document.getElementById('calc-reward').textContent = `$${rewardAmount.toFixed(2)}`;
            document.getElementById('calc-ratio').textContent = `1:${ratio.toFixed(2)}`;
            document.getElementById('calc-ratio').className = `text-lg font-bold ${
                ratio >= 2 ? 'text-green-600' : ratio >= 1.5 ? 'text-yellow-600' : 'text-red-600'
            }`;
            document.getElementById('calc-volume').textContent = positionSize;
            document.getElementById('calc-risk-pips').textContent = `${riskPoints.toFixed(2)} ${pointLabel}`;
            document.getElementById('calc-reward-pips').textContent = `${rewardPoints.toFixed(2)} ${pointLabel}`;

            if (exitPrice) {
                document.getElementById('calc-actual-pips').textContent = `${actualPoints > 0 ? '+' : ''}${actualPoints.toFixed(2)} ${pointLabel}`;
                document.getElementById('calc-actual-pips').className = `font-medium ${actualPoints >= 0 ? 'text-green-600' : 'text-red-600'}`;
                document.getElementById('calc-actual-pnl').textContent = `$${actualPnL > 0 ? '+' : ''}${actualPnL.toFixed(2)}`;
                document.getElementById('calc-actual-pnl').className = `font-medium ${actualPnL >= 0 ? 'text-green-600' : 'text-red-600'}`;
                document.getElementById('actual-pips-container').classList.remove('hidden');
                document.getElementById('actual-pnl-container').classList.remove('hidden');
            } else {
                document.getElementById('actual-pips-container').classList.add('hidden');
                document.getElementById('actual-pnl-container').classList.add('hidden');
            }

            document.getElementById('calculations').classList.remove('hidden');

            return { riskPoints, rewardPoints, ratio, riskAmount, rewardAmount, actualPoints, actualPnL };
        }

        function validateTradeForm() {
            const symbol = document.getElementById('symbol').value.trim();
            const entryPrice = document.getElementById('entryPrice').value.trim();
            const stopLoss = document.getElementById('stopLoss').value.trim();
            const takeProfit = document.getElementById('takeProfit').value.trim();
            const positionSize = document.getElementById('positionSize').value.trim();

            const calculations = calculateTradingMetrics();
            const isValid = symbol && entryPrice && stopLoss && takeProfit && positionSize && 
                           calculations && calculations.ratio >= 1.5;

            const statusEl = document.getElementById('trade-status');
            const submitBtn = document.getElementById('submit-trade-btn');

            if (isValid) {
                statusEl.textContent = 'Valid Setup';
                statusEl.className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
                submitBtn.textContent = 'Enter Trade';
                submitBtn.className = 'flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700';
                submitBtn.disabled = false;
            } else {
                statusEl.textContent = 'Incomplete';
                statusEl.className = 'px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                submitBtn.textContent = 'Complete Required Fields';
                submitBtn.className = 'flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
                submitBtn.disabled = true;
            }
        }

        function checkAndProceed() {
            const criticalItems = document.querySelectorAll('.critical-item');
            const allChecked = Array.from(criticalItems).every(item => item.checked);
            
            if (allChecked) {
                showView('trade-entry');
            }
        }

        function submitTrade() {
            if (isEmergencyLocked) {
                showEmergencyModal();
                return;
            }

            const calculations = calculateTradingMetrics();
            if (!calculations) return;

            const newTrade = {
                id: Date.now(),
                symbol: document.getElementById('symbol').value.toUpperCase(),
                side: document.getElementById('side').value,
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                stopLoss: parseFloat(document.getElementById('stopLoss').value),
                takeProfit: parseFloat(document.getElementById('takeProfit').value),
                positionSize: parseFloat(document.getElementById('positionSize').value),
                exitPrice: parseFloat(document.getElementById('exitPrice').value) || null,
                confidence: parseInt(document.getElementById('confidence').value),
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString(),
                actualPoints: calculations.actualPoints,
                pnl: calculations.actualPnL || (Math.random() > 0.6 ? Math.random() * 100 + 50 : -(Math.random() * 50 + 25)),
                outcome: calculations.actualPnL ? (calculations.actualPnL > 0 ? 'win' : 'loss') : (Math.random() > 0.6 ? 'win' : 'loss')
            };

            trades.push(newTrade);
            localStorage.setItem('mbalotech_trades', JSON.stringify(trades));

            // Reset form
            ['symbol', 'entryPrice', 'stopLoss', 'takeProfit', 'positionSize', 'exitPrice', 'notes'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('confidence').value = '3';
            document.getElementById('confidence-value').textContent = '3';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

            updateDashboard();
            showView('dashboard');
        }

        // Emergency Stop Functions
        function emergencyStop() {
            if (confirm('üö® Are you sure you want to activate Emergency Stop?\n\nThis will:\n‚Ä¢ Suspend trading for 24 hours\n‚Ä¢ Help prevent emotional decisions\n‚Ä¢ Protect your capital\n\nActivate Emergency Stop?')) {
                isEmergencyLocked = true;
                lockEndTime = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
                
                localStorage.setItem('mbalotech_emergency_lock', 'true');
                localStorage.setItem('mbalotech_lock_end_time', lockEndTime);
                
                showEmergencyModal();
                updateDashboard();
            }
        }

        function showEmergencyModal() {
            document.getElementById('lock-end-time').textContent = new Date(lockEndTime).toLocaleString();
            document.getElementById('emergency-modal').classList.remove('hidden');
        }

        function closeEmergencyModal() {
            document.getElementById('emergency-modal').classList.add('hidden');
        }

        function checkEmergencyLock() {
            if (isEmergencyLocked && lockEndTime) {
                const now = new Date();
                const lockEnd = new Date(lockEndTime);
                
                if (now > lockEnd) {
                    // Lock expired
                    isEmergencyLocked = false;
                    lockEndTime = null;
                    localStorage.removeItem('mbalotech_emergency_lock');
                    localStorage.removeItem('mbalotech_lock_end_time');
                }
            }
        }

        // Data Management Functions
        function clearAllTrades() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear ALL trading data?\n\nThis will permanently delete:\n‚Ä¢ All trade records\n‚Ä¢ All statistics\n‚Ä¢ All history\n\nThis action cannot be undone!')) {
                if (confirm('üö® FINAL WARNING: This will delete everything!\n\nType "DELETE" in your mind and click OK if you\'re absolutely sure.')) {
                    trades = [];
                    localStorage.removeItem('mbalotech_trades');
                    updateDashboard();
                    alert('‚úÖ All trade data has been cleared.');
                    showView('dashboard');
                }
            }
        }

        // Export Functions
        function exportToCSV() {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }

            const headers = ['Date', 'Symbol', 'Side', 'Entry Price', 'Exit Price', 'Stop Loss', 'Take Profit', 'Position Size', 'Points', 'P&L', 'Outcome', 'Confidence', 'Notes'];
            
            const csvContent = [
                headers.join(','),
                ...trades.map(trade => [
                    new Date(trade.timestamp).toLocaleDateString(),
                    trade.symbol,
                    trade.side,
                    trade.entryPrice,
                    trade.exitPrice || '',
                    trade.stopLoss,
                    trade.takeProfit,
                    trade.positionSize,
                    trade.actualPoints || '',
                    trade.pnl.toFixed(2),
                    trade.outcome,
                    trade.confidence || '',
                    `"${(trade.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mbalotech-trades-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToJSON() {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                totalTrades: trades.length,
                trades: trades
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mbalotech-trades-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportToGoogleSheets() {
            if (trades.length === 0) {
                alert('No trades to export!');
                return;
            }

            // Create CSV format for Google Sheets
            const headers = ['Date', 'Time', 'Symbol', 'Side', 'Entry Price', 'Exit Price', 'Stop Loss', 'Take Profit', 'Position Size', 'Points', 'P&L', 'Outcome', 'Confidence', 'Notes'];
            
            const sheetsData = trades.map(trade => {
                const date = new Date(trade.timestamp);
                return [
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    trade.symbol,
                    trade.side.toUpperCase(),
                    trade.entryPrice,
                    trade.exitPrice || '',
                    trade.stopLoss,
                    trade.takeProfit,
                    trade.positionSize,
                    trade.actualPoints || '',
                    trade.pnl.toFixed(2),
                    trade.outcome.toUpperCase(),
                    trade.confidence || '',
                    trade.notes || ''
                ];
            });

            // Create the CSV content
            const csvContent = [headers.join(','), ...sheetsData.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');
            
            // Copy to clipboard for easy pasting into Google Sheets
            navigator.clipboard.writeText(csvContent).then(() => {
                alert(`üìã Trading data copied to clipboard!\n\nTo import into Google Sheets:\n1. Open Google Sheets\n2. Create a new spreadsheet\n3. Paste (Ctrl+V) the data\n4. Choose "Split text to columns" if prompted\n\nTotal trades: ${trades.length}`);
            }).catch(() => {
                // Fallback: download as CSV
                exportToCSV();
                alert('üìã Clipboard access denied. Downloaded CSV file instead.\n\nTo import into Google Sheets:\n1. Open Google Sheets\n2. File ‚Üí Import ‚Üí Upload\n3. Select the downloaded CSV file');
            });
        }

        function updateDetailedStats() {
            if (trades.length === 0) {
                document.getElementById('detailed-stats').innerHTML = '<div class="col-span-2 text-gray-500">No trades yet</div>';
                return;
            }

            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.outcome === 'win').length;
            const losingTrades = trades.filter(t => t.outcome === 'loss').length;
            const totalPnL = trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 0;
            
            const avgWin = winningTrades > 0 ? trades.filter(t => t.outcome === 'win').reduce((sum, t) => sum + t.pnl, 0) / winningTrades : 0;
            const avgLoss = losingTrades > 0 ? Math.abs(trades.filter(t => t.outcome === 'loss').reduce((sum, t) => sum + t.pnl, 0)) / losingTrades : 0;
            const profitFactor = avgLoss > 0 ? (avgWin * winningTrades) / (avgLoss * losingTrades) : 0;
            
            const bestTrade = trades.reduce((best, trade) => trade.pnl > best.pnl ? trade : best, trades[0]);
            const worstTrade = trades.reduce((worst, trade) => trade.pnl < worst.pnl ? trade : worst, trades[0]);

            document.getElementById('detailed-stats').innerHTML = `
                <div><strong>Total P&L:</strong> ${totalPnL.toFixed(2)}</div>
                <div><strong>Win Rate:</strong> ${winRate}%</div>
                <div><strong>Avg Win:</strong> ${avgWin.toFixed(2)}</div>
                <div><strong>Avg Loss:</strong> ${avgLoss.toFixed(2)}</div>
                <div><strong>Profit Factor:</strong> ${profitFactor.toFixed(2)}</div>
                <div><strong>Risk/Reward:</strong> ${avgLoss > 0 ? (avgWin/avgLoss).toFixed(2) : 'N/A'}</div>
                <div><strong>Best Trade:</strong> ${bestTrade.pnl.toFixed(2)}</div>
                <div><strong>Worst Trade:</strong> ${worstTrade.pnl.toFixed(2)}</div>
            `;
        }

        function updateDashboard() {
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.outcome === 'win').length;
            const totalPnL = trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(1) : 0;

            document.getElementById('total-trades').textContent = totalTrades;
            document.getElementById('winning-trades').textContent = winningTrades;
            document.getElementById('losing-trades').textContent = totalTrades - winningTrades;
            document.getElementById('win-rate').textContent = `${winRate}%`;
            document.getElementById('total-pnl').textContent = `${totalPnL.toLocaleString()}`;
            
            const progressToGoal = Math.max(0, (totalPnL / 480000 * 100)).toFixed(2);
            document.getElementById('progress-bar').style.width = `${Math.min(progressToGoal, 100)}%`;
            document.getElementById('progress-text').textContent = `${progressToGoal}% complete`;

            // Update recent trades
            if (trades.length > 0) {
                const recentTradesHtml = trades.slice(-5).reverse().map(trade => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded hover:bg-gray-100 transition-colors mb-2">
                        <div class="flex items-center space-x-3">
                            <div class="font-medium">${trade.symbol}</div>
                            <div class="px-2 py-1 rounded text-xs font-medium ${
                                trade.side === 'long' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }">${trade.side.toUpperCase()}</div>
                            <div class="text-sm font-medium ${
                                trade.outcome === 'win' ? 'text-green-600' : 'text-red-600'
                            }">${trade.pnl > 0 ? '+' : ''}${trade.pnl.toFixed(2)}</div>
                            ${trade.actualPoints ? `
                                <div class="text-xs ${trade.actualPoints > 0 ? 'text-green-500' : 'text-red-500'}">
                                    ${trade.actualPoints > 0 ? '+' : ''}${trade.actualPoints.toFixed(2)} pts
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${typeof trade.entryPrice === 'number' ? trade.entryPrice.toFixed(2) : trade.entryPrice}</div>
                            <div class="text-xs text-gray-500">
                                ${new Date(trade.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('recent-trades').innerHTML = recentTradesHtml;
            }
        }

        // Event listeners
        function setupEventListeners() {
            const tradeInputs = ['symbol', 'entryPrice', 'stopLoss', 'takeProfit', 'positionSize', 'exitPrice'];
            tradeInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', validateTradeForm);
                }
            });

            document.getElementById('side').addEventListener('change', validateTradeForm);

            // Confidence slider
            const confidenceSlider = document.getElementById('confidence');
            const confidenceValue = document.getElementById('confidence-value');
            confidenceSlider.addEventListener('input', () => {
                confidenceValue.textContent = confidenceSlider.value;
            });

            // Checklist validation
            document.querySelectorAll('.critical-item').forEach(item => {
                item.addEventListener('change', () => {
                    const allChecked = Array.from(document.querySelectorAll('.critical-item')).every(cb => cb.checked);
                    const proceedBtn = document.getElementById('proceed-btn');
                    
                    if (allChecked) {
                        proceedBtn.textContent = 'Proceed to Trade Entry';
                        proceedBtn.className = 'flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-green-600 text-white hover:bg-green-700';
                        proceedBtn.disabled = false;
                    } else {
                        const unchecked = Array.from(document.querySelectorAll('.critical-item')).filter(cb => !cb.checked).length;
                        proceedBtn.textContent = `Complete ${unchecked} Critical Items`;
                        proceedBtn.className = 'flex-1 py-3 px-4 rounded-lg font-medium transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
                        proceedBtn.disabled = true;
                    }
                });
            });
        }

        // Initialize app immediately
        updateDateTime();
        updateDashboard();
        setupEventListeners();
        checkEmergencyLock();
        setInterval(() => {
            updateDateTime();
            checkEmergencyLock();
        }, 60000);

        // Update detailed stats when settings view is shown
        const originalShowView = showView;
        showView = function(viewName) {
            originalShowView(viewName);
            if (viewName === 'settings') {
                updateDetailedStats();
            }
        };

        console.log('MbaloTech Trading App loaded successfully!');
    </script>
</body>
</html>